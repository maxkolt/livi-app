#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —á–µ—Ä–µ–∑ SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

echo "==========================================="
echo "–ü–ï–†–ï–ó–ê–ü–£–°–ö BACKEND –°–ï–†–í–ï–†–ê"
echo "==========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∏–ª–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)
if [ -d "/opt/livi-app/backend" ]; then
    BACKEND_DIR="/opt/livi-app/backend"
elif [ -d "backend" ]; then
    BACKEND_DIR="backend"
else
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è backend –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    exit 1
fi

cd "$BACKEND_DIR" || exit 1

echo "üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2
if ! command -v pm2 &> /dev/null; then
    echo "‚ùå PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PM2: npm install -g pm2"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
echo "üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å PM2:"
pm2 status
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª
if [ -f ".env" ]; then
    echo "‚úÖ –§–∞–π–ª .env –Ω–∞–π–¥–µ–Ω"
    if grep -q "MONGO_DB=" .env; then
        echo "‚úÖ MONGO_DB –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–µ–∑ –ø–∞—Ä–æ–ª—è
        grep "MONGO_DB" .env | sed 's|://[^:]*:[^@]*@|://***:***@|' | head -1
    else
        echo "‚ö†Ô∏è  MONGO_DB –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env"
    fi
else
    echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é livi-backend..."
pm2 restart livi-backend

if [ $? -eq 0 ]; then
    echo "‚úÖ Backend –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    echo ""
    
    # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    echo "‚è≥ –ñ–¥—É 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
    sleep 3
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    echo ""
    echo "üìä –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:"
    pm2 status
    echo ""
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫):"
    pm2 logs livi-backend --lines 30 --nostream
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB –≤ –ª–æ–≥–∞—Ö:"
    pm2 logs livi-backend --lines 50 --nostream | grep -i "mongo\|connected\|error" | tail -10
    echo ""
    
    echo "==========================================="
    echo "‚úÖ –ì–û–¢–û–í–û!"
    echo "==========================================="
    echo ""
    echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:"
    echo "  pm2 logs livi-backend"
    echo ""
    echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞:"
    echo "  pm2 status"
    echo ""
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ backend"
    echo ""
    echo "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é:"
    echo "  cd $BACKEND_DIR"
    echo "  pm2 delete livi-backend"
    echo "  pm2 start npm --name 'livi-backend' -- run start"
    echo "  pm2 save"
    exit 1
fi
