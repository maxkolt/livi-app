# VPN и WebRTC - Решение проблем

## Проблемы с VPN на iOS

VPN на iOS может вызывать следующие проблемы с WebRTC:

### 1. Блокировка сетевых запросов
- **Симптом**: `Network request failed` при загрузке ICE конфигурации
- **Причина**: VPN может блокировать или изменять HTTP запросы
- **Решение**: Добавлен retry с увеличенными таймаутами (5 попыток, 15 секунд)

### 2. Блокировка UDP трафика
- **Симптом**: RTCPeerConnection не может установить соединение
- **Причина**: VPN может блокировать UDP (используется WebRTC для P2P)
- **Решение**: Использовать TURN сервер (relay-only режим)

### 3. Изменение NAT трафика
- **Симптом**: Соединение устанавливается, но видео/аудио не передается
- **Причина**: VPN изменяет NAT, что мешает прямому P2P соединению
- **Решение**: Использовать TURN сервер для ретрансляции

## Что было исправлено

1. **Увеличены таймауты для iOS**:
   - Таймаут: 15 секунд (было 8)
   - Retry: 5 попыток (было 3)
   - Задержка между попытками: 2s, 4s, 6s, 8s, 10s

2. **Улучшена обработка ошибок**:
   - Определение VPN проблем
   - Предупреждения в логах
   - Автоматический fallback на конфигурацию из .env

3. **Рекомендации в логах**:
   - При обнаружении сетевых проблем на iOS выводится предупреждение о VPN

## Рекомендации для пользователей с VPN

### Вариант 1: Отключить VPN (рекомендуется)
Если возможно, отключите VPN для использования приложения.

### Вариант 2: Использовать relay-only режим
Если VPN необходим, включите relay-only режим в `.env`:

```bash
EXPO_PUBLIC_ICE_RELAY_ONLY=1
```

Это заставит WebRTC использовать только TURN сервер (без прямых P2P соединений), что обходит проблемы VPN с UDP.

### Вариант 3: Настроить VPN исключения
Настройте VPN так, чтобы он не блокировал:
- Ваш сервер: `89.111.152.241:3000`
- TURN сервер: `89.111.152.241:3478`
- STUN серверы (Google, Cloudflare)

## Проверка работы

После исправлений проверьте логи:

1. **Успешная загрузка ICE конфигурации**:
   ```
   [ICE Config] Server configuration loaded: { hasTurn: true, ... }
   ```

2. **При проблемах с VPN**:
   ```
   [ICE Config] ⚠️ Network issues detected on iOS. Consider using relay-only mode if VPN is active.
   ```

3. **RTCPeerConnection создается успешно**:
   ```
   [RandomChatSession] ✅ RTCPeerConnection создан успешно
   ```

## Дополнительная диагностика

Если проблемы сохраняются:

1. Проверьте доступность сервера через VPN:
   ```bash
   curl http://89.111.152.241:3000/api/turn-credentials
   ```

2. Проверьте нативные логи iOS в Xcode:
   - Откройте Xcode
   - Window → Devices and Simulators
   - Выберите устройство → View Device Logs
   - Ищите ошибки WebRTC

3. Попробуйте другой VPN сервис или настройки VPN
